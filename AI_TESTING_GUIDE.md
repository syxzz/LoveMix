# 🎮 AI 对话功能测试指南

## 快速开始

### 1. 启动应用

```bash
npm start
# 或
expo start
```

### 2. 进入游戏

1. 打开应用
2. 登录或游客模式
3. 选择一个剧本
4. 选择一个角色
5. 进入游戏

### 3. 测试 AI 对话

#### 测试场景 1: 与 DM 对话

**步骤**:
1. 在游戏界面点击"与 DM 对话"按钮
2. 输入问题："我应该从哪里开始调查？"
3. 等待 AI 回复（约 2-5 秒）
4. 点击"查看思考过程"查看 AI 的推理

**预期结果**:
- ✅ AI 给出合理的调查建议
- ✅ 不直接透露答案
- ✅ 能看到 AI 的思考过程
- ✅ 回复符合 DM 的角色定位

**示例对话**:
```
你: 我应该从哪里开始调查？

DM: 作为一名侦探，你应该先从案发现场开始。仔细观察现场的每一个细节，
    寻找可能的线索。同时，也要注意死者的人际关系，往往真相就隐藏在
    这些关系之中。

[查看思考过程]
💭 用户询问调查方向。作为DM，我需要给出引导性建议，但不能直接告诉
   答案。应该提示他关注现场和人际关系这两个关键方向...
```

#### 测试场景 2: 与角色对话

**步骤**:
1. 在游戏界面选择一个角色
2. 点击进入对话
3. 输入问题："你昨晚在哪里？"
4. 观察角色的回答是否符合其性格

**预期结果**:
- ✅ 角色回答符合其性格设定
- ✅ 如果角色有秘密，会表现出回避或撒谎
- ✅ 能看到角色的思考过程
- ✅ 多轮对话保持一致性

**示例对话**:
```
你: 你昨晚在哪里？

张三: 我...我昨晚在家里休息。为什么这么问？

[查看思考过程]
💭 玩家询问我的行踪。我需要隐瞒昨晚去过案发现场的事实。应该表现出
   一些紧张，但不能太明显。先给出一个模糊的回答...
```

#### 测试场景 3: 多轮对话

**步骤**:
1. 与 DM 或角色进行 3-5 轮对话
2. 观察 AI 是否记住之前的对话内容
3. 退出对话界面
4. 重新进入，检查历史是否保存

**预期结果**:
- ✅ AI 能记住之前的对话
- ✅ 回答有连贯性
- ✅ 历史对话被正确保存
- ✅ 重新进入能看到历史记录

#### 测试场景 4: 思考链功能

**步骤**:
1. 在任何对话中
2. 点击"查看思考过程"
3. 阅读 AI 的推理过程
4. 点击"隐藏思考过程"

**预期结果**:
- ✅ 能展开思考过程
- ✅ 思考过程有逻辑性
- ✅ 能折叠思考过程
- ✅ 思考过程用斜体显示

## 测试检查清单

### 功能测试

- [ ] 能成功进入对话界面
- [ ] 能发送消息
- [ ] AI 能正常回复
- [ ] 思考过程能展开/折叠
- [ ] 对话历史能保存
- [ ] 能区分 DM 和角色对话
- [ ] Loading 状态正常显示
- [ ] 错误提示正常工作

### 内容质量测试

- [ ] DM 回复符合主持人角色
- [ ] 角色回复符合性格设定
- [ ] 不会直接透露答案
- [ ] 给出的提示有帮助
- [ ] 思考过程合理
- [ ] 多轮对话有连贯性

### UI/UX 测试

- [ ] 消息气泡样式正确
- [ ] 用户消息在右侧
- [ ] AI 消息在左侧
- [ ] 角色标识清晰
- [ ] 思考过程区域美观
- [ ] 输入框功能正常
- [ ] 发送按钮状态正确
- [ ] 自动滚动到底部

### 性能测试

- [ ] AI 响应时间 < 10 秒
- [ ] 界面不卡顿
- [ ] 长对话不影响性能
- [ ] 内存占用正常

## 常见问题

### Q: AI 回复很慢怎么办？

**A**:
1. 检查网络连接
2. AI 首次回复可能需要 5-10 秒
3. 如果超过 30 秒，可能是网络问题

### Q: AI 回复不符合预期？

**A**:
1. 检查系统提示词是否合理
2. 调整 temperature 参数（0.7-0.9）
3. 提供更多上下文信息

### Q: 思考过程不显示？

**A**:
1. 确认 API 返回了 reasoning_content
2. 检查 Message 类型定义
3. 查看控制台是否有错误

### Q: 对话历史丢失？

**A**:
1. 确认调用了 saveGameProgress
2. 检查 AsyncStorage 权限
3. 查看是否有存储错误

## 调试技巧

### 1. 查看 API 请求

在 `src/services/ai.ts` 中添加日志:

```typescript
console.log('发送请求:', requestBody);
console.log('收到响应:', data);
```

### 2. 查看对话历史

在 DialogScreen 中添加:

```typescript
useEffect(() => {
  console.log('当前消息:', messages);
}, [messages]);
```

### 3. 测试 API 连接

```typescript
// 简单测试
const testAPI = async () => {
  try {
    const result = await talkToDM(
      script,
      character,
      [],
      '测试消息'
    );
    console.log('API 测试成功:', result);
  } catch (error) {
    console.error('API 测试失败:', error);
  }
};
```

## 性能监控

### 监控 API 调用时间

```typescript
const startTime = Date.now();
const result = await talkToDM(...);
const endTime = Date.now();
console.log(`API 调用耗时: ${endTime - startTime}ms`);
```

### 监控 Token 使用

```typescript
if (result.usage) {
  console.log('Token 使用:', result.usage);
  console.log('推理 Token:', result.usage.reasoningTokens);
}
```

## 反馈收集

测试时请记录:

1. **功能问题**: 哪些功能不工作
2. **内容问题**: AI 回复质量如何
3. **性能问题**: 响应速度如何
4. **UI 问题**: 界面是否美观易用
5. **建议**: 有什么改进建议

## 下一步

测试完成后，可以:

1. ✅ 优化系统提示词
2. ✅ 调整 AI 参数
3. ✅ 添加更多对话场景
4. ✅ 集成线索分析功能
5. ✅ 集成结局生成功能

## 联系支持

如果遇到问题:
1. 查看控制台错误信息
2. 检查 API 配置
3. 参考 AI_INTEGRATION_COMPLETE.md
4. 查看 AI_SERVICE_GUIDE.md

祝测试顺利！🎉
