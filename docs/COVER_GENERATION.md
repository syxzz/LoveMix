# 剧本封面图片生成指南

## 概述

为了提供最佳用户体验，剧本封面图片采用自动生成和智能缓存策略：
- 避免 AI 生成中文文字可能出现的乱码问题
- 在应用启动时后台自动生成封面
- 使用内存+持久化双层缓存，确保快速加载

## 图片生成策略

### 1. 避免中文乱码
- 所有图片生成提示词使用纯英文
- 明确要求 AI 不生成任何文字、字母或字符
- 只生成纯视觉插图（维多利亚庄园、雷雨夜等悬疑场景）

### 2. 自动生成时机
- **应用启动时**: 后台自动为所有没有封面的剧本生成封面
- **首次访问时**: 如果启动时未完成，访问详情页时会触发生成
- **非阻塞式**: 生成过程不会阻塞应用启动或页面加载

### 3. 智能缓存机制
- **内存缓存**: 应用启动时预加载到内存，访问时零延迟
- **持久化缓存**: 使用 AsyncStorage 持久化存储，重启应用后仍可用
- **优先级**: 预设封面 > 内存缓存 > 持久化缓存 > 实时生成

## 工作流程

```
应用启动
  ↓
预加载缓存到内存
  ↓
后台检查所有剧本
  ↓
为缺失封面的剧本生成图片
  ↓
保存到缓存（内存+持久化）
  ↓
用户访问详情页
  ↓
立即从内存缓存显示封面
```

## 代码结构

### 核心文件

1. **[src/services/scriptInit.ts](../src/services/scriptInit.ts)**
   - 封面缓存管理
   - 自动生成逻辑
   - 内存缓存优化

2. **[src/services/ai.ts](../src/services/ai.ts)**
   - 图片生成 API 调用
   - 纯英文提示词

3. **[App.tsx](../App.tsx)**
   - 应用启动时初始化
   - 预加载缓存

4. **[src/screens/ScriptDetailScreen.tsx](../src/screens/ScriptDetailScreen.tsx)**
   - 显示封面图片
   - 处理加载状态

### 关键函数

- `preloadCoverCache()`: 预加载缓存到内存
- `ensureScriptCover(script)`: 确保剧本有封面（优先缓存，必要时生成）
- `initializeAllScriptCovers(scripts)`: 后台批量初始化所有剧本封面
- `getCachedCover(scriptId)`: 从内存缓存获取封面（快速）
- `saveCoverToCache(scriptId, url)`: 保存封面到缓存

## 性能优化

1. **零延迟访问**: 内存缓存确保已生成的封面立即显示
2. **非阻塞生成**: 后台生成不影响应用启动速度
3. **请求限流**: 批量生成时每个请求间隔 1 秒，避免 API 限流
4. **智能跳过**: 已有封面的剧本不会重复生成

## 图片生成 API

- **服务**: CharaBoard 图片生成 API
- **模型**: `gemini-2.5-flash-image`
- **风格**: 日式漫画/动漫风格，黑色电影美学
- **比例**: 16:9
- **主题**: 维多利亚庄园、雷雨夜、悬疑氛围

## 调试工具

```typescript
import { clearCoverCache } from './src/services/scriptInit';

// 清除所有缓存（用于测试）
await clearCoverCache();
```

## 添加新剧本

当添加新剧本时，有两种方式提供封面：

### 方式 1: 预设封面（推荐）
在剧本数据中直接指定 `coverImage` URL：

```typescript
{
  id: 'new_script',
  title: '新剧本',
  coverImage: 'https://example.com/cover.jpg', // 预设封面
  // ... 其他字段
}
```

### 方式 2: 自动生成
不设置 `coverImage` 字段，系统会在应用启动时自动生成：

```typescript
{
  id: 'new_script',
  title: '新剧本',
  // coverImage 留空，将自动生成
  // ... 其他字段
}
```

## 注意事项

1. **首次生成**: 首次生成封面需要网络请求，可能需要几秒钟
2. **缓存持久化**: 生成后的封面会永久缓存，除非手动清除
3. **网络依赖**: 图片 URL 依赖外部服务，确保 URL 不会过期
4. **错误处理**: 生成失败时会显示占位图，不影响其他功能

## 未来改进

- [ ] 支持本地存储图片文件
- [ ] 添加封面预览和重新生成功能
- [ ] 支持自定义封面上传
- [ ] 优化图片加载性能（预加载、懒加载等）
